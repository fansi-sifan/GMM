---
title: "GMM report"
author: "Sifan Liu"
date: "2018/3/13"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('dplyr')
library('ggplot2')
source('Func.R', local = TRUE)
```

## R Markdown

This is an R Markdown document for Global Metro Monitor 2018 analysis



```{r Set up}

GMM17 <- read.csv("source/GMM17_world_wide_groups.csv")
GMM17 <- GMM17 %>%
  filter(country != "World") %>%
  mutate(region_adj = ifelse(country == "China", "China", as.character(region))) %>%
  mutate(income_adj = ifelse(incomegroup == "High income", "Advanced economy", "Emerging Economy")) %>%
  select(metro, country, region, region_adj, incomegroup, income_adj, ismetro,
         emptot_2000:poptott_2017)
head(GMM17)
```

## Collapse by groups
Collapse master data by different type of cuts (region, income, etc.), show result for all cities, all countries and the subset of cities.
```{r collapse by group}
groups <- names(GMM17)[2:6]

city <- lapply(groups, function(x)group_summary(GMM17, 1, x))
country <- lapply(groups, function(x)group_summary(GMM17, 0, x))
city_sub <- lapply(seq(1:5), function(x)(cbind(country[[x]][,1:2], country[[x]][,3:75]-city[[x]][,3:75])))

city_sub <- lapply(city_sub, mutate,ismetro = -1)

names(city_sub) <- names(country) <- names(city) <- groups

```

## Generate variables of interest
GDPPK calculates real GDP per capita, VG calculates absolute difference in values between the start year and end year (choose from "gdpusc", "emptot" or "poptott"); CAGR calculates compound annual growth rate between the start year and end year (choose from "gdpusc", "gdppk", "emptot" or "poptott")

```{r analysis function}

analysis <- function(dataframe,start,end){
  temp <- GDPPK(dataframe)
  temp <- CAGR(temp, "gdpusc", start, end)
  temp <- CAGR(temp, "emptot", start, end)
  temp <- CAGR(temp, "gdppk", start, end)
  temp <- VG(temp, "gdpusc", start, end)
  result <- temp %>% 
    select(1,2,ends_with(paste0(start)), 
                         ends_with(paste0(end)))
  return(result)
}



#knitr::kable(test, 'html')

```


## Set up scope of analysis

Change the start and end year of different time period (select from 2000 to 2017)

```{r time frame}

list <- lapply(1:5, function(i)bind_rows(city[i], country[i], city_sub[i]))

Short <- lapply(list, analysis, 2014, 2016)
Med <- lapply(list, analysis, 2011, 2016)
Long <- lapply(list, analysis, 2000, 2016)

Short <- lapply(Short, mutate,timeperiod = "Short")
Med <- lapply(Med, mutate,timeperiod = "Med")
Long <- lapply(Long, mutate,timeperiod = "Long")

names(Short) <- names(Med) <- names(Long) <- groups

list <- lapply(1:5, function(i)rbind(Short[[i]], setNames(Med[[i]], names(Short[[i]]))))
list <- lapply(1:5, function(i)rbind(list[[i]], setNames(Long[[i]], names(list[[i]]))))

names(list) <- groups

```

## Save output

```{r save, include=FALSE}

setwd("V:/MetroMonitor/Global Monitor/Global Monitor V/Data/01182018/Sifan/result/All data")
# 
lapply(1:5, function(x)write.csv(Short[x], file = paste0("Short.", names(Short[x]), ".csv")))
# lapply(1:5, function(x)write.csv(Med[x], file = paste0("Med_", names(Med[x]), ".csv")))
lapply(1:5, function(x)write.csv(Long[x], file = paste0("Long.", names(Long[x]), ".csv")))


```


## Plot
```{r}


barplot <- function(scope, var){
# select data
    data <- list[[scope]]
  data$ismetro <- factor(ifelse(data$ismetro > 0, 1, data$ismetro))
  data <- filter(data, ismetro != 0 )
# draw the bar plot
  ggplot(data, aes_string(scope, var, fill = "ismetro")) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.5)) +
    scale_x_discrete(labels = abbreviate)+
    facet_grid(.~timeperiod)
  
  ggsave(paste0("V:/MetroMonitor/Global Monitor/Global Monitor V/Data/01182018/Sifan/result/Plots/",scope,"_",var,".png"),
               width = 15, height = 8)
}

barplot("region_adj", "CAGR_gdppk_2014_2016")
barplot("region", "CAGR_gdppk_2014_2016")
barplot("income_adj", "CAGR_gdppk_2014_2016")
barplot("incomegroup", "CAGR_gdppk_2014_2016")

barplot("region", "CAGR_gdpusc_2014_2016")
barplot("region_adj", "CAGR_gdpusc_2014_2016")
barplot("income_adj", "CAGR_gdpusc_2014_2016")
barplot("incomegroup", "CAGR_gdpusc_2014_2016")

barplot("region", "CAGR_emptot_2014_2016")
barplot("region_adj", "CAGR_emptot_2014_2016")
barplot("income_adj", "CAGR_emptot_2014_2016")
barplot("incomegroup", "CAGR_emptot_2014_2016")


```

```{r}

stackplot <- function(scope, var){
# select data
    data <- list[[scope]]
  data$ismetro <- factor(ifelse(data$ismetro > 0, 1, data$ismetro))
  data <- filter(data, ismetro != 0 )
# draw the bar plot
  ggplot(data, aes_string(scope, var, fill = "ismetro")) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
    scale_x_discrete(labels = abbreviate)+
    facet_grid(.~timeperiod)
  
  ggsave(paste0("V:/MetroMonitor/Global Monitor/Global Monitor V/Data/01182018/Sifan/result/Plots/",scope,"_",var,".png"),
               width = 15, height = 8)
}

# Distribution of increase in output in three period
stackplot("region", "VG_gdpusc_2014_2016")
stackplot("region_adj", "VG_gdpusc_2014_2016")
stackplot("income_adj", "VG_gdpusc_2014_2016")
stackplot("incomegroup", "VG_gdpusc_2014_2016")

# Distribution of real GDP in year 2000, 2011 2014
stackplot("region", "gdpusc_2014")
stackplot("region_adj", "gdpusc_2014")
stackplot("income_adj", "gdpusc_2014")
stackplot("incomegroup", "gdpusc_2014")

```

